<!-- <!DOCTYPE html>
<html>
<head>
    <title>YOLO ì–¼êµ´ ë¶„ì„</title>
</head>
<body>
    <h1>ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</h1>
    <input type="file" id="imageInput" accept="image/*"><br><br>
    
    <div id="resultMessage"></div>
    <img id="resultImage" src="" alt="ê²°ê³¼ ì´ë¯¸ì§€" style="display:none; width:400px;">

    <script>
       
        const input = document.getElementById("imageInput");
        const resultMsg = document.getElementById("resultMessage");
        const resultImg = document.getElementById("resultImage");

        input.addEventListener("change", async function () {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            resultMsg.innerText = "ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...";
            resultImg.style.display = "none";

            const response = await fetch("/analyze/", {
                method: "POST",
                body: formData
            });

            const data = await response.json();

            resultMsg.innerText = data.result;
            if (data.image_url) {
                resultImg.src = data.image_url + "?t=" + new Date().getTime();  // ìºì‹± ë°©ì§€
                resultImg.style.display = "block";
            }
        });
    </script>
</body>
</html> -->
<!DOCTYPE html>
<html>
<head>
    <title>AI í”¼ë¶€ ë¶„ì„ ë° ì¶”ì²œ</title>
    <style>
        body { font-family: 'Arial', sans-serif; display: flex; flex-direction: column; align-items: center; }
        .main-container { display: flex; width: 90%; max-width: 1200px; margin-top: 20px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        .analysis-area { flex: 1; padding-right: 20px; border-right: 1px solid #eee; }
        .chatbot-container { flex: 1; padding-left: 20px; display: flex; flex-direction: column; height: 600px; }
        .chat-header { background-color: #4CAF50; color: white; padding: 10px; text-align: center; border-radius: 5px 5px 0 0; }
        .chat-window { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; border: 1px solid #ddd; border-top: none; }
        .message { max-width: 80%; padding: 8px 12px; border-radius: 15px; word-wrap: break-word; }
        .user-message { align-self: flex-end; background-color: #DCF8C6; }
        .bot-message { align-self: flex-start; background-color: #EAEAEA; }
        .input-container { padding-top: 10px; border-top: 1px solid #ddd; display: flex; }
        #user-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        #send-button { background-color: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        #send-button:disabled { background-color: #A5D6A7; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>AI ê¸°ë°˜ í”¼ë¶€ ë¶„ì„ ë° ë§ì¶¤ ì¶”ì²œ</h1>
    
    <div class="main-container">
        <div class="analysis-area">
            <h2>ì´ë¯¸ì§€ ë¶„ì„</h2>
            <input type="file" id="imageInput" accept="image/*"><br><br>
            
            <div id="resultMessage">ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...</div>
            <img id="resultImage" src="" alt="ê²°ê³¼ ì´ë¯¸ì§€" style="display:none; width:400px;">
        </div>

        <div class="chatbot-container">
            <div class="chat-header">ë§ì¶¤í˜• í™”ì¥í’ˆ ì „ë¬¸ê°€</div>
            <div class="chat-window" id="chat-window">
                <div class="message bot-message">ì•ˆë…•í•˜ì„¸ìš”! ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì€ í›„, ì§ˆë¬¸í•´ ì£¼ì‹œë©´ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”.</div>
            </div>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸í•˜ì„¸ìš”..." >
                <button id="send-button">ì „ì†¡</button>
            </div>
        </div>
    </div>
    
    <script>
        // ğŸš¨ ì±—ë´‡ API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • (Django urls.py ê²½ë¡œ í™•ì¸) ğŸš¨
        

        // DOM ìš”ì†Œ ì •ì˜
        const input = document.getElementById("imageInput");
        const resultMsg = document.getElementById("resultMessage");
        const resultImg = document.getElementById("resultImage");
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let currentAnalysisResult = null; // ğŸš¨ AI ë¶„ì„ ê²°ê³¼ JSONì„ ì €ì¥í•  ë³€ìˆ˜

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function appendMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            messageDiv.textContent = text;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- 1ë‹¨ê³„: AI ë¶„ì„ ë¡œì§ (ê¸°ì¡´ ì½”ë“œ ìˆ˜ì •) ---
        input.addEventListener("change", async function () {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            resultMsg.innerText = "ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... (ë¶„ì„ ì¤‘)";
            resultImg.style.display = "none";


            try {
                const response = await fetch("/analyze/", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();

                // ğŸš¨ í•µì‹¬ ìˆ˜ì •: data.resultëŠ” JSON ê°ì²´ì´ë¯€ë¡œ ë¬¸ìì—´ë¡œ í‘œì‹œ
                resultMsg.innerText = JSON.stringify(data.result, null, 2); 
                
                if (response.ok && data.image_url) {
                    // âœ… 1. ë¶„ì„ ì„±ê³µ: ì±—ë´‡ í™œì„±í™” ë° ê²°ê³¼ ì €ì¥
                    resultImg.src = data.image_url + "?t=" + new Date().getTime(); 
                    resultImg.style.display = "block";
                    
                    // ğŸš¨ data.resultê°€ ìµœì¢… ê²°ê³¼ JSONì´ë¼ê³  ê°€ì •í•˜ê³  ì €ì¥
                    currentAnalysisResult = data.result; 
                    
                    appendMessage('bot', 'âœ… AI ë¶„ì„ ì™„ë£Œ! ì´ì œ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ í™”ì¥í’ˆì„ ì¶”ì²œë°›ìœ¼ì„¸ìš”.');
                    userInput.focus();
                    
                } else {
                    // 2. ë¶„ì„ ì‹¤íŒ¨ (threshold ë¯¸ë‹¬ ë“±)
                    currentAnalysisResult = null;
                    appendMessage('bot', `âš ï¸ ë¶„ì„ ì‹¤íŒ¨: ${data.result}`);
                }
            } catch (error) {
                resultMsg.innerText = "ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                appendMessage('bot', 'ğŸ”´ ë¶„ì„ ì„œë²„ì— ì ‘ì†í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });


        // --- 2ë‹¨ê³„: ì±—ë´‡ ì „ì†¡ ë¡œì§ (ì‹ ê·œ ì¶”ê°€) ---

        async function sendChatRequest(query) {
            
            if (!query) return;
            appendMessage('user', query);
            
            // ğŸš¨ ì¿¼ë¦¬ ê°•í™”: ë¶„ì„ ê²°ê³¼ JSONì„ ë¬¸ìì—´ë¡œ ë§Œë“¤ì–´ ì‚¬ìš©ì ì§ˆë¬¸ì— ê²°í•©
            const analysisString = JSON.stringify(currentAnalysisResult);
            const finalQuery = `ë‚˜ì˜ í”¼ë¶€ ë¶„ì„ ê²°ê³¼ëŠ” ${analysisString} ì…ë‹ˆë‹¤. ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ${query}`;

            // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ ë° UI ë¹„í™œì„±í™”
            const spinner = document.createElement('div');
            spinner.classList.add('message', 'bot-message', 'spinner'); // spinner CSS í•„ìš”
            chatWindow.appendChild(spinner);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            userInput.disabled = true;
            sendButton.disabled = true;

            try {
                const response = await fetch("/recommend/", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: finalQuery }) // â¬…ï¸ ê°•í™”ëœ ì¿¼ë¦¬ ì „ì†¡
                });

                chatWindow.removeChild(spinner);
                
                const data = await response.json();
                const botAnswer = data.recommendation || data.error || "ë‹µë³€ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                
                appendMessage('bot', botAnswer);

            } catch (error) {
                const currentSpinner = document.querySelector('.spinner');
                if (currentSpinner) chatWindow.removeChild(currentSpinner);
                appendMessage('bot', `ğŸ”´ ì±—ë´‡ ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${error.message}`);
            } finally {
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.value = '';
                userInput.focus();
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        sendButton.addEventListener('click', () => {
            const query = userInput.value.trim();
            if (query) {
                sendChatRequest(query);
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
        
    </script>
</body>
</html>